

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>engine &mdash; tk-aftereffects v0.4.5 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href='https://help.autodesk.com/view/SGDEV/ENU/'>
    
        <img style='width: 191px;
                height: 60px;
                margin: 2px;
                border-radius: 0px;
                padding: 0px;'
            src='../_static/logo@2x.png'/>
    
    </a>
    

          
          
          <a href="../index.html" class="icon icon-home">
            tk-aftereffects
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Public Helper Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hooks.html">Hooks</a></li>
</ul>


    <a href='genindex.html'>Alphabetic Index</a>

    <div style='margin-top: 50px;
                margin-left: 10px;
                margin-right: 10px;
                padding: 10px;
                color: #b3b3b3;
                font-size: 70%;
                border-radius: 3px;
                background-color: #444;
                line-height: 18px;
                '>
    <style>
        a.custom_post_menu { display: inline;
                             padding: 0px;
                             text-decoration: underline; }
    </style>

    <b>tk-aftereffects</b> v0.4.5.<br>
    
        This documentation is part of the Flow Production Tracking.
    
    For more information, please visit
    <a class=custom_post_menu href='https://help.autodesk.com/view/SGDEV/ENU/'>The Flow Production Tracking developer portal.</a>.
    The code associated with this documentation can be found
    <a class=custom_post_menu href='https://github.com/shotgunsoftware/tk-aftereffects'>here</a>.

    </div>
    <style>
        p.privacy_links { margin: 4px 0px;}
    </style>
    <p class="privacy_links"><a data-opt-in-preferences href="javascript:;">Privacy settings</a></p>
    <p class="privacy_links"><a data-wat-linkname="manage-ccpa-settings-footer-link" href="javascript:;">Do not sell my personal information</a></p>
    <p class="privacy_links"><a href="https://www.autodesk.com/company/legal-notices-trademarks/privacy-statement">Privacy/Cookies</a></p>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tk-aftereffects</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">engine</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for engine</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2019 Shotgun Software Inc.</span>
<span class="c1">#</span>
<span class="c1"># CONFIDENTIAL AND PROPRIETARY</span>
<span class="c1">#</span>
<span class="c1"># This work is provided &quot;AS IS&quot; and subject to the Shotgun Pipeline Toolkit</span>
<span class="c1"># Source Code License included in this distribution package. See LICENSE.</span>
<span class="c1"># By accessing, using, copying or modifying this work you indicate your</span>
<span class="c1"># agreement to the Shotgun Pipeline Toolkit Source Code License. All rights</span>
<span class="c1"># not expressly granted therein are reserved by Shotgun Software Inc.</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>


<span class="kn">import</span> <span class="nn">sgtk</span>
<span class="kn">from</span> <span class="nn">sgtk.util.filesystem</span> <span class="kn">import</span> <span class="n">ensure_folder_exists</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tank_vendor</span> <span class="kn">import</span> <span class="n">sgutils</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tank_vendor</span> <span class="kn">import</span> <span class="n">six</span> <span class="k">as</span> <span class="n">sgutils</span>


<div class="viewcode-block" id="AfterEffectsEngine"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine">[docs]</a><span class="k">class</span> <span class="nc">AfterEffectsEngine</span><span class="p">(</span><span class="n">sgtk</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">Engine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An After Effects CC engine for Shotgun Toolkit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the maximum size for a generated thumbnail</span>
    <span class="n">MAX_THUMB_SIZE</span> <span class="o">=</span> <span class="mi">512</span>

    <span class="n">SHOTGUN_ADOBE_HEARTBEAT_INTERVAL</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">SHOTGUN_ADOBE_HEARTBEAT_TOLERANCE</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">SHOTGUN_ADOBE_NETWORK_DEBUG</span> <span class="o">=</span> <span class="s2">&quot;SHOTGUN_ADOBE_NETWORK_DEBUG&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>

    <span class="n">TEST_SCRIPT_BASENAME</span> <span class="o">=</span> <span class="s2">&quot;run_tests.py&quot;</span>

    <span class="n">PY_TO_JS_LOG_LEVEL_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CRITICAL&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ERROR&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WARNING&quot;</span><span class="p">:</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INFO&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">_SHOTGUN_ADOBE_PORT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SHOTGUN_ADOBE_PORT&quot;</span><span class="p">)</span>
    <span class="n">_SHOTGUN_ADOBE_APPID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SHOTGUN_ADOBE_APPID&quot;</span><span class="p">)</span>

    <span class="n">_COMMAND_UID_COUNTER</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_LOCK</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">_FAILED_PINGS</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_CONTEXT_CACHE</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">_CHECK_CONNECTION_TIMER</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_CONTEXT_CHANGES_DISABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_DIALOG_PARENT</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_WIN32_AFTEREFFECTS_MAIN_HWND</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_PROXY_WIN_HWND</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_HEARTBEAT_DISABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_PROJECT_CONTEXT</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_AFX_PID</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_POPUP_CACHE</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_AFX_WIN32_DIALOG_WINDOW_CLASS</span> <span class="o">=</span> <span class="s2">&quot;#32770&quot;</span>  <span class="c1"># the windows window class name used by After Effects for modal dialogs</span>
    <span class="n">__WIN32_GW_CHILD</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">_CONTEXT_CACHE_KEY</span> <span class="o">=</span> <span class="s2">&quot;aftereffects_context_cache&quot;</span>

    <span class="n">_HAS_CHECKED_CONTEXT_POST_LAUNCH</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">__CC_VERSION_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">12</span><span class="p">:</span> <span class="s2">&quot;2015&quot;</span><span class="p">,</span>
        <span class="mi">13</span><span class="p">:</span> <span class="s2">&quot;2016&quot;</span><span class="p">,</span>
        <span class="mi">14</span><span class="p">:</span> <span class="s2">&quot;2017&quot;</span><span class="p">,</span>
        <span class="mi">15</span><span class="p">:</span> <span class="s2">&quot;2018&quot;</span><span class="p">,</span>
        <span class="mi">16</span><span class="p">:</span> <span class="s2">&quot;2019&quot;</span><span class="p">,</span>
        <span class="mi">17</span><span class="p">:</span> <span class="s2">&quot;2020&quot;</span><span class="p">,</span>
        <span class="mi">18</span><span class="p">:</span> <span class="s2">&quot;2021&quot;</span><span class="p">,</span>
        <span class="mi">22</span><span class="p">:</span> <span class="s2">&quot;2022&quot;</span><span class="p">,</span>
        <span class="mi">23</span><span class="p">:</span> <span class="s2">&quot;2023&quot;</span><span class="p">,</span>
        <span class="mi">24</span><span class="p">:</span> <span class="s2">&quot;2024&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">__IS_SEQUENCE_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[\[]?([#@]+|[%]0\dd)[\]]?&quot;</span><span class="p">)</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># context changing</span>

    <span class="k">def</span> <span class="nf">post_context_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_context</span><span class="p">,</span> <span class="n">new_context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs after a context change has occurred. This will trigger the</span>
<span class="sd">        new state to be sent to the Adobe CC host application.</span>

<span class="sd">        :param old_context: The previous context.</span>
<span class="sd">        :param new_context: The current context.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># keep track of schema load for the current project to make sure we</span>
        <span class="c1"># aren&#39;t trying to use sg globals prior to load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__schema_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># get the project id to supply to sg globals</span>
        <span class="k">if</span> <span class="n">new_context</span><span class="o">.</span><span class="n">project</span><span class="p">:</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="n">new_context</span><span class="o">.</span><span class="n">project</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># callback to set the schema loaded flag</span>
        <span class="k">def</span> <span class="nf">_on_schema_loaded</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__schema_loaded</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># tell sg globals to load the schema for the current project. sg globals</span>
        <span class="c1"># will run the callback immediately if already cached so this is likely</span>
        <span class="c1"># very quick.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__shotgun_globals</span><span class="o">.</span><span class="n">run_on_schema_loaded</span><span class="p">(</span>
            <span class="n">_on_schema_loaded</span><span class="p">,</span> <span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span>
        <span class="p">)</span>

        <span class="c1"># go ahead and start the process of sending the current state back to js</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_state</span><span class="p">()</span>

        <span class="c1"># If the context is set in the environment, then we&#39;ll update it with</span>
        <span class="c1"># the new one. This will mean that a CEP extension restart will come</span>
        <span class="c1"># back up with the same context that it went down with. We have to set</span>
        <span class="c1"># this in ExtendScript, because it&#39;s the parent process of any CEP and</span>
        <span class="c1"># Python processes that get spawned. By setting it at the top, it&#39;ll be</span>
        <span class="c1"># propagated down to any of After Effects&#39;s subprocesses.</span>
        <span class="k">if</span> <span class="s2">&quot;TANK_CONTEXT&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">dollar</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;TANK_CONTEXT&quot;</span><span class="p">,</span> <span class="n">new_context</span><span class="o">.</span><span class="n">serialize</span><span class="p">())</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># engine initialization</span>

    <span class="k">def</span> <span class="nf">pre_app_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the engine into an operational state. This method called before</span>
<span class="sd">        any apps are loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># import and keep a handle on the bundled python module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;tk_aftereffects&quot;</span><span class="p">)</span>

        <span class="c1"># constant command uid lookups for these special commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__jump_to_sg_command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_command_uid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__jump_to_fs_command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_command_uid</span><span class="p">()</span>

        <span class="c1"># get the adobe instance. it may have been initialized already by a</span>
        <span class="c1"># previous instance of the engine. if not, initialize a new one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adobe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">AdobeBridge</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_name</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SHOTGUN_ADOBE_PORT</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">network_debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SHOTGUN_ADOBE_NETWORK_DEBUG</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Network debug logging is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adobe</span><span class="o">.</span><span class="n">network_debug</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Initializing...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,))</span>

        <span class="c1"># connect to all the adobe bridge signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">logging_received</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_logging</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">command_received</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">active_document_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_active_document_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">run_tests_request_received</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_tests</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">state_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__send_state</span><span class="p">)</span>

        <span class="c1"># in order to use frameworks, they have to be imported via</span>
        <span class="c1"># import_module. so they&#39;re exposed in the bundled python.</span>
        <span class="n">shotgun_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">shotgun_data</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">shotgun_settings</span>
        <span class="c1"># keep a handle for shotgun globals as they are needed in other</span>
        <span class="c1"># functions as well</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__shotgun_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">shotgun_globals</span>

        <span class="c1"># import here since the engine is responsible for defining Qt.</span>
        <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtCore</span>

        <span class="c1"># create a data retriever for async querying of sg data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data</span> <span class="o">=</span> <span class="n">shotgun_data</span><span class="o">.</span><span class="n">ShotgunDataRetriever</span><span class="p">(</span>
            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># get outselves a settings manager where we can store metadata.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings_manager</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># connect the retriever signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data</span><span class="o">.</span><span class="n">work_completed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_worker_signal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data</span><span class="o">.</span><span class="n">work_failure</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_worker_failure</span><span class="p">)</span>

        <span class="c1"># context request uids. we keep track of these to make sure we&#39;re only</span>
        <span class="c1"># processing the current requests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__context_find_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__context_thumb_uid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># keep track if sg global schema has been cached</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__schema_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># start the retriever thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># keep a list of handles on the launched dialogs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__qt_dialogs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">post_app_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs after all apps have been initialized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">event_processor</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtGui</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">event_processor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__setup_connection_timer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_state</span><span class="p">()</span>

        <span class="c1"># forward the log file path back to the js side. this is used to direct</span>
        <span class="c1"># clients to the file in the event of an error</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">LogManager</span><span class="p">()</span><span class="o">.</span><span class="n">base_file_handler</span><span class="o">.</span><span class="n">baseFilename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">send_log_file_path</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>

        <span class="c1"># If there are fewer than 2 documents open, we don&#39;t need the stored</span>
        <span class="c1"># cache, regardless of whether this is a restart situation or a fresh</span>
        <span class="c1"># launch of AE. In that case, we take the opportunity to clear anything</span>
        <span class="c1"># that might exist in the stored cache, as it&#39;s data we don&#39;t need.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Single document found, clearing stored context cache.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__settings_manager</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CACHE_KEY</span><span class="p">,</span>
            <span class="nb">dict</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Normally the bootstrap logic would handle the file open, but since the bootstrap logic is handled by</span>
        <span class="c1"># the adobe framework, and is generic, we should handle it here.</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SGTK_FILE_TO_OPEN&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_to_open</span><span class="p">:</span>
            <span class="c1"># open the specified script</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">))</span>
            <span class="c1"># clear the environment variable after loading so that it doesn&#39;t get reopened on an engine restart.</span>
            <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SGTK_FILE_TO_OPEN&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">destroy_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the engine should tear down itself and all its apps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Destroying engine...&quot;</span><span class="p">)</span>

        <span class="c1"># Set our parent widget back to being owned by the window manager</span>
        <span class="c1"># instead of After Effects&#39;s application window.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PROXY_WIN_HWND</span> <span class="ow">and</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_windows</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">SetParent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_PROXY_WIN_HWND</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># No longer poll for new messages from this engine.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CHECK_CONNECTION_TIMER</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CHECK_CONNECTION_TIMER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># We&#39;re going to hide and force the garbage collection of any dialogs</span>
        <span class="c1"># that we know about. This will stop memory leaks, and is also prudent</span>
        <span class="c1"># since we&#39;re severing the socket.io connection that will allow them</span>
        <span class="c1"># to function properly.</span>
        <span class="n">dialogs_still_opened</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_qt_dialogs</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">dialog</span> <span class="ow">in</span> <span class="n">dialogs_still_opened</span><span class="p">:</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Gracefully stop our data retriever. This call will block until the</span>
        <span class="c1"># currently-processing request has completed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># Disconnect from the server.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="c1"># Disconnect the signals in case there are references to this engine</span>
        <span class="c1"># out there. without disconnecting, it will still respond to signals</span>
        <span class="c1"># from the adobe bridge.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">logging_received</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_logging</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">command_received</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">active_document_changed</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_active_document_change</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">run_tests_request_received</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_tests</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">state_requested</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__send_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post_qt_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called externally once a ``QApplication`` has been created and completes</span>
<span class="sd">        the engine setup process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We need to have the RPC API call processEvents during its response</span>
        <span class="c1"># wait loop. This will keep that loop from blocking the UI thread.</span>
        <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtGui</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">event_processor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span>

        <span class="c1"># Since this is running in our own Qt event loop, we&#39;ll use the bundled</span>
        <span class="c1"># dark look and feel. breaking encapsulation to do so.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing default styling...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_dark_look_and_feel</span><span class="p">()</span>

        <span class="c1"># Sets up the heartbeat timer to run asynchronously.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setup_connection_timer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a new command with the engine. For Adobe RPC purposes,</span>
<span class="sd">        a &quot;uid&quot; property is added to the command&#39;s properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_command_uid</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AfterEffectsEngine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">callback</span><span class="p">,</span>
            <span class="n">properties</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">host_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns information about the application hosting this engine.</span>

<span class="sd">        :returns: A {&quot;name&quot;: application name, &quot;version&quot;: application version}</span>
<span class="sd">                  dictionary. eg: {&quot;name&quot;: &quot;AfterFX&quot;, &quot;version&quot;: &quot;2017.1.1&quot;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="p">:</span>
            <span class="c1"># Don&#39;t error out if the bridge was not yet started</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;AfterFX&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>

        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">version</span>
        <span class="c1"># app.aftereffects.AfterEffectsVersion just returns 18.1.1 which is not what users see in the UI</span>
        <span class="c1"># extract a more meaningful version from the systemInformation property</span>
        <span class="c1"># which gives something like:</span>
        <span class="c1"># Adobe After Effects Version: 2017.1.1 20170425.r.252 2017/04/25:23:00:00 CL 1113967  x64\rNumber of .....</span>
        <span class="c1"># and use it instead if available.</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+\.?\d*)&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">sgutils</span><span class="o">.</span><span class="n">ensure_str</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
        <span class="n">major</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cc_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CC_VERSION_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;AfterFX&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">cc_version</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_initialize_dark_look_and_feel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override the base engine method.</span>
<span class="sd">        Apply specific styling for this DCC.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtGui</span>

        <span class="c1"># Initialize the SG Toolkit style to the application.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_initialize_dark_look_and_feel</span><span class="p">()</span>

        <span class="c1"># Apply specific styling</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="n">app_palette</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">palette</span><span class="p">()</span>
        <span class="c1"># The default placeholder text for this DCC is black, let&#39;s set it back to</span>
        <span class="c1"># the text color (as it was in Qt5), but with the current placeholder</span>
        <span class="c1"># text alpha value.</span>
        <span class="n">new_placeholder_text_color</span> <span class="o">=</span> <span class="n">app_palette</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">color</span><span class="p">()</span>
        <span class="n">placeholder_text_color</span> <span class="o">=</span> <span class="n">app_palette</span><span class="o">.</span><span class="n">placeholderText</span><span class="p">()</span><span class="o">.</span><span class="n">color</span><span class="p">()</span>
        <span class="n">new_placeholder_text_color</span><span class="o">.</span><span class="n">setAlpha</span><span class="p">(</span><span class="n">placeholder_text_color</span><span class="o">.</span><span class="n">alpha</span><span class="p">())</span>
        <span class="n">app_palette</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPalette</span><span class="o">.</span><span class="n">PlaceholderText</span><span class="p">,</span> <span class="n">new_placeholder_text_color</span><span class="p">)</span>
        <span class="c1"># Set the palette back with the specific styling</span>
        <span class="n">app</span><span class="o">.</span><span class="n">setPalette</span><span class="p">(</span><span class="n">app_palette</span><span class="p">)</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># engine host interaction methods</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the active project filepath.</span>

<span class="sd">        :returns: The current project path or an empty string</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">doc_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">file</span>
        <span class="n">doc_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># doc_obj will always be a ProxyWrapper instance so we cannot</span>
        <span class="c1"># use the `doc_obj is not None` comparison</span>
        <span class="k">if</span> <span class="n">doc_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">doc_path</span> <span class="o">=</span> <span class="n">doc_obj</span><span class="o">.</span><span class="n">fsName</span>
        <span class="k">return</span> <span class="n">doc_path</span>

<div class="viewcode-block" id="AfterEffectsEngine.save"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the project in place or to the given file-path</span>

<span class="sd">        :param str path: The target file path. optional.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_changes_disabled</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># After Effects won&#39;t ensure that the folder is</span>
                <span class="c1"># created when saving, so we must make sure it exists</span>
                <span class="n">ensure_folder_exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved file to to </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_path</span><span class="p">))</span></div>

<div class="viewcode-block" id="AfterEffectsEngine.save_as"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.save_as">[docs]</a>    <span class="k">def</span> <span class="nf">save_as</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launch a Qt file browser to select a file, then save the supplied</span>
<span class="sd">        project to that path.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtGui</span>

        <span class="n">doc_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>

        <span class="c1"># After Effects doesn&#39;t appear to have a</span>
        <span class="c1"># &quot;save as&quot; dialog accessible via</span>
        <span class="c1"># python. so open our own Qt file dialog.</span>
        <span class="n">file_dialog</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="p">(</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dialog_parent</span><span class="p">(),</span>
            <span class="n">caption</span><span class="o">=</span><span class="s2">&quot;Save As&quot;</span><span class="p">,</span>
            <span class="n">directory</span><span class="o">=</span><span class="n">doc_path</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;After Effects Documents (*.aep, *.aepx)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">file_dialog</span><span class="o">.</span><span class="n">setLabelText</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">Accept</span><span class="p">,</span> <span class="s2">&quot;Save&quot;</span><span class="p">)</span>
        <span class="n">file_dialog</span><span class="o">.</span><span class="n">setLabelText</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">Reject</span><span class="p">,</span> <span class="s2">&quot;Cancel&quot;</span><span class="p">)</span>
        <span class="n">file_dialog</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">DontResolveSymlinks</span><span class="p">)</span>
        <span class="n">file_dialog</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">DontUseNativeDialog</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">file_dialog</span><span class="o">.</span><span class="n">selectedFiles</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">AdobeItemTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This returns a constant class that maps constants against</span>
<span class="sd">        adobe aftereffects internal class names.</span>

<span class="sd">        :returns: AdobeItemTypes constants object. see :class:`~python.tk_aftereffects.AdobeItemTypes`</span>
<span class="sd">        :rtype: AdobeItemTypes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">afx_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;tk_aftereffects&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">afx_module</span><span class="o">.</span><span class="n">AdobeItemTypes</span>

<div class="viewcode-block" id="AfterEffectsEngine.is_item_of_type"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.is_item_of_type">[docs]</a>    <span class="k">def</span> <span class="nf">is_item_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">adobe_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicates whether the given item is of the given AdobeItemType.</span>

<span class="sd">        :param item: item to be checked.</span>
<span class="sd">        :type item: `adobe.ItemObject`_</span>
<span class="sd">        :param str adobe_type: AdobeItemType-constant. One of the constants held by :class:`~python.tk_aftereffects.AdobeItemTypes`</span>
<span class="sd">        :returns: Indicating if the given item is of the given type</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;instanceof&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">adobe_type</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper getting the currently selected item in the after effects project</span>

<span class="sd">        :returns: The active item</span>
<span class="sd">        :rtype: `adobe.ItemObject`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">activeItem</span>

<div class="viewcode-block" id="AfterEffectsEngine.is_adobe_sequence"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.is_adobe_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">is_adobe_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to query if an adobe-style render path is</span>
<span class="sd">        describing a sequence.</span>

<span class="sd">        The sequencepath must contain one of the following patterns in</span>
<span class="sd">        order to be recognized::</span>

<span class="sd">            ###</span>
<span class="sd">            @@@</span>
<span class="sd">            [###]</span>
<span class="sd">            %0xd</span>

<span class="sd">        :param str path: filepath to check</span>
<span class="sd">        :returns: True if the path describes a sequence</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__IS_SEQUENCE_REGEX</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="AfterEffectsEngine.check_sequence"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.check_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">check_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">queue_item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to query if all render files of a given queue item</span>
<span class="sd">        are actually existing.</span>

<span class="sd">        :param str path: filepath to check</span>
<span class="sd">        :param queue_item: an after effects render queue item</span>
<span class="sd">        :type queue_item: `adobe.RenderQueueItemObject`_</span>
<span class="sd">        :returns: True if the path describes a sequence</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_render_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">queue_item</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AfterEffectsEngine.iter_collection"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.iter_collection">[docs]</a>    <span class="k">def</span> <span class="nf">iter_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to iter safely through an adobe-collection item</span>
<span class="sd">        as its index starts at 1, not 0.</span>

<span class="sd">        One may use this method like this::</span>

<span class="sd">            item_collection = engine.adobe.project.items</span>
<span class="sd">            for item in engine.iter_collection(item_collection):</span>
<span class="sd">                print item.name</span>

<span class="sd">        :param collection_item: the after-effects collection item to iter</span>
<span class="sd">        :type collection_item: `adobe.ItemCollectionObject`_</span>
<span class="sd">        :yields: the next child item of the collection</span>
<span class="sd">        :rtype: `adobe.ItemObject`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">collection_item</span><span class="o">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">collection_item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="AfterEffectsEngine.get_render_files"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.get_render_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_render_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">queue_item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yields all render-files and its frame number of a given</span>
<span class="sd">        after effects render queue item.</span>

<span class="sd">        The path is needed to uniquely identify the correct output_module</span>

<span class="sd">        :param str path: filepath to iter</span>
<span class="sd">        :param queue_item: an after effects render queue item</span>
<span class="sd">        :type queue_item: `adobe.RenderQueueItemObject`_</span>
<span class="sd">        :yields: 2-item-tuple where the firstitem is the resolved path (str)</span>
<span class="sd">                of the render file and the second item the frame-number or</span>
<span class="sd">                None if the path is not an image-sequence.</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># is the given render-path a sequence?</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__IS_SEQUENCE_REGEX</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="c1"># if not, we just check if the file exists</span>
            <span class="k">yield</span> <span class="n">path</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">return</span>  <span class="c1"># Exit the iterator</span>

        <span class="c1"># if yes, we check the existence of each frame</span>
        <span class="n">frame_time</span> <span class="o">=</span> <span class="n">queue_item</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">frameDuration</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">queue_item</span><span class="o">.</span><span class="n">timeSpanStart</span> <span class="o">/</span> <span class="n">frame_time</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">frame_numbers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">queue_item</span><span class="o">.</span><span class="n">timeSpanDuration</span> <span class="o">/</span> <span class="n">frame_time</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">skip_frames</span> <span class="o">=</span> <span class="n">queue_item</span><span class="o">.</span><span class="n">skipFrames</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">test_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">0</span><span class="si">%d</span><span class="s2">d&quot;</span> <span class="o">%</span> <span class="n">padding</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">frame_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">frame_numbers</span><span class="p">,</span> <span class="n">skip_frames</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">test_path</span> <span class="o">%</span> <span class="n">frame_no</span><span class="p">,</span> <span class="n">frame_no</span></div>

<div class="viewcode-block" id="AfterEffectsEngine.import_filepath"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.import_filepath">[docs]</a>    <span class="k">def</span> <span class="nf">import_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to import footage into the current comp.</span>
<span class="sd">        This method contains logic to determine as what the given file-path</span>
<span class="sd">        may be imported (PROJECT, FOOTAGE, COMP etc.)</span>
<span class="sd">        To influence this logic you can implement the &quot;import_footage_hook&quot;</span>
<span class="sd">        for this engine.</span>
<span class="sd">        It will also collect all new items and return those in case</span>
<span class="sd">        the import leads to more than one (1) Item-objects to be imported.</span>

<span class="sd">        :param str path: filepath to be imported. Sequences should give either the</span>
<span class="sd">                first frame or the frames replaced by hashes (#), at (@) or the</span>
<span class="sd">                percent formatting (%04d) syntax.</span>
<span class="sd">        :returns: All new items that were imported</span>
<span class="sd">        :rtype: list-of-`adobe.CompItemObject`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">import_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">ImportOptions</span><span class="p">()</span>
        <span class="n">import_options</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file_obj</span>
        <span class="n">import_options</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execute_hook_method</span><span class="p">(</span>
            <span class="s2">&quot;import_footage_hook&quot;</span><span class="p">,</span> <span class="s2">&quot;set_import_options&quot;</span><span class="p">,</span> <span class="n">import_options</span><span class="o">=</span><span class="n">import_options</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__import_file</span><span class="p">(</span><span class="n">import_options</span><span class="p">)</span></div>

<div class="viewcode-block" id="AfterEffectsEngine.add_items_to_comp"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.add_items_to_comp">[docs]</a>    <span class="k">def</span> <span class="nf">add_items_to_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_collection</span><span class="p">,</span> <span class="n">comp_item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method that adds the &quot;best-matching&quot; items from a given</span>
<span class="sd">        adobe.CollectionItem into a given CompItem. Where &quot;best-matching&quot;</span>
<span class="sd">        means, that the first CompItem found is added alternatively the first</span>
<span class="sd">        Footage item is added.</span>
<span class="sd">        In case the collection contains only FolderItems, this method will</span>
<span class="sd">        recurse into the folders until one ItemObject was found.</span>

<span class="sd">        :param item_collection: object to be analyzed</span>
<span class="sd">        :type item_collection: `adobe.ItemCollectionObject`_</span>
<span class="sd">        :param comp_item: comp that should receive the items from item_collection</span>
<span class="sd">        :type comp_item: `adobe.CompItemObject`_</span>
<span class="sd">        :returns: Indicating if an item was added or not.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># first we generate a list of items within</span>
        <span class="c1"># the given collection (FolderItem), because</span>
        <span class="c1"># we have different include-priorities per</span>
        <span class="c1"># type</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">footage</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_collection</span><span class="p">(</span><span class="n">item_collection</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_item_of_type</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdobeItemTypes</span><span class="o">.</span><span class="n">FOLDER_ITEM</span><span class="p">):</span>
                <span class="n">folders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_item_of_type</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdobeItemTypes</span><span class="o">.</span><span class="n">COMP_ITEM</span><span class="p">):</span>
                <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_item_of_type</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdobeItemTypes</span><span class="o">.</span><span class="n">FOOTAGE_ITEM</span><span class="p">):</span>
                <span class="n">footage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># if there is a comp in the given folder,</span>
        <span class="c1"># then we prefer to add this to the comp,</span>
        <span class="c1"># as it is likely to include the other layers</span>
        <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">comp_and_footage</span> <span class="o">=</span> <span class="n">comps</span> <span class="o">+</span> <span class="n">footage</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">added</span> <span class="ow">and</span> <span class="n">comp_and_footage</span><span class="p">:</span>
            <span class="n">comp_item</span> <span class="o">=</span> <span class="n">comp_item</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comp_and_footage</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># in case no footage was added, we recurse into</span>
        <span class="c1"># the folders until we find something or return None</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">added</span> <span class="ow">and</span> <span class="n">folders</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">folders</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_items_to_comp</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">comp_item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">added</span></div>

<div class="viewcode-block" id="AfterEffectsEngine.render_queue_item"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.render_queue_item">[docs]</a>    <span class="k">def</span> <span class="nf">render_queue_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        renders a given queue_item, by disabling all other queued items</span>
<span class="sd">        and only enabling the given item. After rendering the state of the</span>
<span class="sd">        render-queue is reverted.</span>

<span class="sd">        :param queue_item: The render queue item to be rendered</span>
<span class="sd">        :type queue_item: `adobe.RenderQueueItemObject`_</span>
<span class="sd">        :returns: Indicating successful rendering or not</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># save the queue state for all unrendered items</span>
        <span class="n">queue_item_state_cache</span> <span class="o">=</span> <span class="p">[(</span><span class="n">queue_item</span><span class="p">,</span> <span class="n">queue_item</span><span class="o">.</span><span class="n">render</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">renderQueue</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="c1"># one cannot change the status on</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">RQItemStatus</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">queue_item_state_cache</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">render</span><span class="p">))</span>
            <span class="n">item</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">queue_item</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start rendering..&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">renderQueue</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># This catches errors thrown during the AfterEffects Render process.</span>
            <span class="c1"># Which may return various different errors. This situation never</span>
            <span class="c1"># occured during development.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;Skipping item due to an error &quot;</span> <span class="s2">&quot;while rendering: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">acceptable_states</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">RQItemStatus</span><span class="o">.</span><span class="n">DONE</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">RQItemStatus</span><span class="o">.</span><span class="n">ERR_STOPPED</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">RQItemStatus</span><span class="o">.</span><span class="n">RENDERING</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="c1"># reverting the original queued state for all</span>
            <span class="c1"># unprocessed items</span>
            <span class="k">while</span> <span class="n">queue_item_state_cache</span><span class="p">:</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">queue_item_state_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_states</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">status</span>

        <span class="c1"># we check for success if the render queue item status</span>
        <span class="c1"># has changed to DONE</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">queue_item</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">RQItemStatus</span><span class="o">.</span><span class="n">DONE</span>
        <span class="k">return</span> <span class="n">success</span></div>

<div class="viewcode-block" id="AfterEffectsEngine.find_sequence_range"><a class="viewcode-back" href="../api.html#engine.AfterEffectsEngine.find_sequence_range">[docs]</a>    <span class="k">def</span> <span class="nf">find_sequence_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the file name in an attempt to determine the first and last</span>
<span class="sd">        frame number of a sequence. This assumes some sort of common convention</span>
<span class="sd">        for the file names, where the frame number is an integer at the end of</span>
<span class="sd">        the basename, just ahead of the file extension, such as</span>
<span class="sd">        ``file.0001.jpg``, or ``file_001.jpg``. We also check for input file names with</span>
<span class="sd">        abstracted frame number tokens, such as ``file.####.jpg`` or ``file.%04d.jpg``.</span>

<span class="sd">        :param str path: The file path to parse.</span>

<span class="sd">        :returns: None if no range could be determined, otherwise (min, max)</span>
<span class="sd">        :rtype: tuple or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This pattern will match the following at the end of a string and</span>
        <span class="c1"># retain the frame number or frame token as group(1) in the resulting</span>
        <span class="c1"># match object:</span>
        <span class="c1">#</span>
        <span class="c1"># 0001</span>
        <span class="c1"># ####</span>
        <span class="c1"># @@@@</span>
        <span class="c1"># [####]</span>
        <span class="c1"># %04d</span>
        <span class="c1">#</span>
        <span class="c1"># The number of digits or hashes does not matter; we match as many as</span>
        <span class="c1"># exist.</span>
        <span class="n">frame_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(^|[\.\_\- ])[\[]?([0-9#@]+|[%]0\d+d)[\]]?$&quot;</span><span class="p">)</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">frame_pattern</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

        <span class="c1"># If we did not match, we don&#39;t know how to parse the file name, or there</span>
        <span class="c1"># is no frame number to extract.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># We need to get all files that match the pattern from disk so that we</span>
        <span class="c1"># can determine what the min and max frame number is.</span>
        <span class="n">glob_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">frame_pattern</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1*&quot;</span><span class="p">,</span> <span class="n">root</span><span class="p">),</span>
            <span class="n">ext</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_path</span><span class="p">)</span>

        <span class="c1"># Our pattern from above matches against the file root, so we need</span>
        <span class="c1"># to chop off the extension at the end.</span>
        <span class="n">file_roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

        <span class="c1"># We know that the search will result in a match at this point, otherwise</span>
        <span class="c1"># the glob wouldn&#39;t have found the file. We can search and pull group 1</span>
        <span class="c1"># to get the integer frame number from the file root name.</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">frame_pattern</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_roots</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frames</span><span class="p">))</span></div>

    <span class="c1">############################################################################</span>
    <span class="c1"># RPC</span>

    <span class="k">def</span> <span class="nf">_check_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make sure we are still connected to the adobe cc product.&quot;&quot;&quot;</span>
        <span class="c1"># If we&#39;re in a disabled state, then we don&#39;t do anything here. This</span>
        <span class="c1"># is controlled by the heartbeat_disabled context manager provided</span>
        <span class="c1"># by this engine.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEARTBEAT_DISABLED</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FAILED_PINGS</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOTGUN_ADOBE_HEARTBEAT_TOLERANCE</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtCore</span>

                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_FAILED_PINGS</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_FAILED_PINGS</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Will allow queued up messages (like logging calls)</span>
            <span class="c1"># to be handled on the Python end.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">process_new_messages</span><span class="p">()</span>

        <span class="c1"># We also have a one-time check we need to make after the timer is</span>
        <span class="c1"># started. In the event that the user opened a document before the</span>
        <span class="c1"># integration completed its initialization, we need to make sure</span>
        <span class="c1"># that the context is correct. Since we rely of After Effects sending</span>
        <span class="c1"># an event on active document change to control our context, if that</span>
        <span class="c1"># occurred before we were listening then we likely missed it and</span>
        <span class="c1"># need to make sure we&#39;re not in a stale state.</span>
        <span class="c1">#</span>
        <span class="c1"># Note: This is occurring in the timer here because the context</span>
        <span class="c1"># change can only occur once the engine initialization process has</span>
        <span class="c1"># completed. As such, we can rely on the timer to delay its execution</span>
        <span class="c1"># until we&#39;re in a state where the context change will succeed.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HAS_CHECKED_CONTEXT_POST_LAUNCH</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">current_engine</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Engine initialization complete -- checking active &quot;</span>
                    <span class="s2">&quot;document context...&quot;</span>
                <span class="p">)</span>

                <span class="n">active_document_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>

                <span class="k">if</span> <span class="n">active_document_path</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;There is an active document. Checking to see if a &quot;</span>
                        <span class="s2">&quot;context change is required.&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_active_document_change</span><span class="p">(</span><span class="n">active_document_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;There is no active document, so there is no need to change context.&quot;</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_HAS_CHECKED_CONTEXT_POST_LAUNCH</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Engine initialization has not completed -- waiting to &quot;</span>
                    <span class="s2">&quot;check the active document context...&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_emit_log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by the engine whenever a new log message is available.</span>

<span class="sd">        All log messages from the toolkit logging namespace will be passed to</span>
<span class="sd">        this method.</span>

<span class="sd">        :param handler: Log handler that this message was dispatched from</span>
<span class="sd">        :type handler: :class:`~python.logging.LogHandler`</span>
<span class="sd">        :param record: Std python logging record</span>
<span class="sd">        :type record: :class:`~python.logging.LogRecord`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If the _adobe attribute is set, then we can forward logging calls</span>
        <span class="c1"># back to the js process via rpc.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_adobe&quot;</span><span class="p">):</span>
            <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PY_TO_JS_LOG_LEVEL_MAPPING</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">]</span>

            <span class="c1"># log the message back to js via rpc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># prior to the _adobe attribute being set, we rely on the js process</span>
        <span class="c1"># handling stdout and logging it.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we don&#39;t use the handler&#39;s format method here because the adobe</span>
            <span class="c1"># side expects a certain format.</span>
            <span class="n">msg_str</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg_str</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_handle_active_document_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_document_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the active document from the host application, determines which</span>
<span class="sd">        context it belongs to, and changes to that context.</span>

<span class="sd">        :param str active_document_path: The path to the new active document.</span>

<span class="sd">        :returns: True if the context changed, False if it did not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the config says to not change context on active document change,</span>
        <span class="c1"># then we don&#39;t do anything here.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;automatic_context_switch&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Engine setting automatic_context_switch is false.&quot;</span>
                <span class="s2">&quot;Not changing context.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Make sure we have a properly-encoded string for the path. We can</span>
        <span class="c1"># possibly get a file path/name that contains unicode, and we don&#39;t</span>
        <span class="c1"># want to deal with that later on.</span>
        <span class="k">if</span> <span class="n">active_document_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">active_document_path</span> <span class="o">=</span> <span class="n">sgutils</span><span class="o">.</span><span class="n">ensure_str</span><span class="p">(</span><span class="n">active_document_path</span><span class="p">)</span>

        <span class="c1"># This will be True if the context_changes_disabled context manager is</span>
        <span class="c1"># used. We&#39;re just in a temporary state of not allowing context changes,</span>
        <span class="c1"># which is useful when an app is doing a lot of After Effects work that</span>
        <span class="c1"># might be triggering active document changes that we don&#39;t want to</span>
        <span class="c1"># result in PTR context changes.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_disabled</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CHANGES_DISABLED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Engine is in &#39;no context changes&#39; mode. Not changing context.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">active_document_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;New active document is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">active_document_path</span><span class="p">)</span>

            <span class="n">cached_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_from_context_cache</span><span class="p">(</span><span class="n">active_document_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cached_context</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">cached_context</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Document found in context cache: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgtk</span><span class="o">.</span><span class="n">context_from_path</span><span class="p">(</span>
                        <span class="n">active_document_path</span><span class="p">,</span>
                        <span class="n">previous_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__add_to_context_cache</span><span class="p">(</span><span class="n">active_document_path</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to determine context from path. Setting the Project context.&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># clear the context finding task ids so that any tasks that</span>
                    <span class="c1"># finish won&#39;t send data to js.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__context_find_uid</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__context_thumb_uid</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># We go to the project context if this is a file outside of</span>
                    <span class="c1"># PTR control.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PROJECT_CONTEXT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_PROJECT_CONTEXT</span> <span class="o">=</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
                            <span class="n">tk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">sgtk</span><span class="p">,</span>
                            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PROJECT_CONTEXT</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">project</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;New context doesn&#39;t have a Project entity. Not changing &quot;</span>
                    <span class="s2">&quot;context.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgtk</span><span class="o">.</span><span class="n">context_from_entity</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">context</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">context_about_to_change</span><span class="p">()</span>
                <span class="n">sgtk</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">change_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_handle_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles an RPC engine command execution request.</span>

<span class="sd">        :param int uid: The unique id of the engine command to run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Handling command request for uid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uid</span><span class="p">,))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_disabled</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtGui</span>

            <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__jump_to_fs_command_id</span><span class="p">:</span>
                <span class="c1"># jump to fs special command triggered</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_jump_to_fs</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__jump_to_sg_command_id</span><span class="p">:</span>
                <span class="c1"># jump to sg special command triggered</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_jump_to_sg</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># a registered command was triggered</span>
                <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">uid</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Executing callback for command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,)</span>
                        <span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]()</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QWidget</span><span class="p">):</span>
                            <span class="c1"># if the callback returns a widget</span>
                            <span class="c1"># keep a handle on it</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__qt_dialogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles an RPC logging request.</span>

<span class="sd">        :param str level: One of &quot;debug&quot;, &quot;info&quot;, &quot;warning&quot;, or &quot;error&quot;.</span>
<span class="sd">        :param str message: The log message.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># manually create a record to log to the standard file handler.</span>
        <span class="c1"># we format it to match the regular logs, but tack on the &#39;.js&#39; to</span>
        <span class="c1"># indicate that it came from javascript.</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">makeLogRecord</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;levelname&quot;</span><span class="p">:</span> <span class="n">level</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.js&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># forward this message to the base file handler so that it is logged</span>
        <span class="c1"># appropriately.</span>
        <span class="k">if</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">LogManager</span><span class="p">()</span><span class="o">.</span><span class="n">base_file_handler</span><span class="p">:</span>
            <span class="n">sgtk</span><span class="o">.</span><span class="n">LogManager</span><span class="p">()</span><span class="o">.</span><span class="n">base_file_handler</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the test suite for the tk-aftereffects bundle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we don&#39;t know what the tests root directory path is</span>
        <span class="c1"># via the environment, then we shouldn&#39;t be here.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tests_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SHOTGUN_ADOBE_TESTS_ROOT&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;The SHOTGUN_ADOBE_TESTS_ROOT environment variable &quot;</span>
                <span class="s2">&quot;must be set to the root directory of the tests to be &quot;</span>
                <span class="s2">&quot;run. Not running tests!&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Make sure we can find the run_tests.py file within the root</span>
            <span class="c1"># that was specified in the environment.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Test root path found. Looking for run_tests.py.&quot;</span><span class="p">)</span>
            <span class="n">test_module</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tests_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEST_SCRIPT_BASENAME</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_module</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to find run_tests.py in the directory &quot;</span>
                    <span class="s2">&quot;specified by the SHOTGUN_ADOBE_TESTS_ROOT &quot;</span>
                    <span class="s2">&quot;environment variable. Not running tests!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found run_tests.py. Importing to run tests.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We need to prepend to sys.path. We&#39;ll set it back to</span>
            <span class="c1"># what it was before once we&#39;re done running the tests.</span>
            <span class="n">original_sys_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
            <span class="n">python_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;python&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">tests_root</span><span class="p">,</span> <span class="n">python_root</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
            <span class="kn">import</span> <span class="nn">run_tests</span>

            <span class="c1"># The run_tests.py module should make available a run_tests</span>
            <span class="c1"># function. We need to run that, giving it the engine pointer</span>
            <span class="c1"># so that it can use that for logging purposes.</span>
            <span class="n">run_tests</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># If we got an unhandled exception, then something went very</span>
            <span class="c1"># wrong in the test suite. We&#39;ll just trap that and print it</span>
            <span class="c1"># as an error without letting it bubble up any farther.</span>
            <span class="kn">import</span> <span class="nn">traceback</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Tests raised the following:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Reset sys.path back to what it was before we started.</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">original_sys_path</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">adobe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The handle to the Adobe RPC API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adobe</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">app_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The runtime app id. This will be a string -- something like</span>
<span class="sd">        PHSP for After Effects, or AEFT for After Effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SHOTGUN_ADOBE_APPID</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context_change_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Specifies that context changes are allowed by the engine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># context manager</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">context_changes_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A context manager that disables context changes on enter, and enables</span>
<span class="sd">        them on exit. This is useful in apps that might be performing operations</span>
<span class="sd">        that require changes in the active document that don&#39;t want to trigger</span>
<span class="sd">        a context change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CHANGES_DISABLED</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CHANGES_DISABLED</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">heartbeat_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A context manager that disables the heartbeat and message processing</span>
<span class="sd">        timer on enter, and restarts it on exit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pausing heartbeat...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEARTBEAT_DISABLED</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to pause heartbeat as requested.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Heartbeat paused.&quot;</span><span class="p">)</span>

        <span class="k">yield</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_HEARTBEAT_DISABLED</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Heartbeat restarted.&quot;</span><span class="p">)</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># UI</span>

    <span class="k">def</span> <span class="nf">_define_qt_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will be called at initialisation time and will allow</span>
<span class="sd">        a user to control various aspects of how QT is being used</span>
<span class="sd">        by Toolkit. The method should return a dictionary with a number</span>
<span class="sd">        of specific keys, outlined below.</span>

<span class="sd">        * qt_core - the QtCore module to use</span>
<span class="sd">        * qt_gui - the QtGui module to use</span>
<span class="sd">        * dialog_base - base class for to use for Toolkit&#39;s dialog factory</span>

<span class="sd">        :returns: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Just call the base implementation and monkey patch QMessageBox.</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AfterEffectsEngine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_define_qt_base</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Unable to find a QT Python module&quot;</span><span class="p">)</span>

        <span class="n">QtCore</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="s2">&quot;qt_core&quot;</span><span class="p">]</span>
        <span class="n">QtGui</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="s2">&quot;qt_gui&quot;</span><span class="p">]</span>

        <span class="c1"># tell QT4 to interpret C strings as utf-8</span>
        <span class="c1"># note: this will be ignored on QT5 via our shim</span>
        <span class="n">utf8</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTextCodec</span><span class="o">.</span><span class="n">codecForName</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">QtCore</span><span class="o">.</span><span class="n">QTextCodec</span><span class="o">.</span><span class="n">setCodecForCStrings</span><span class="p">(</span><span class="n">utf8</span><span class="p">)</span>

        <span class="c1"># override message boxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_override_qmessagebox</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base</span>

    <span class="k">def</span> <span class="nf">_override_qmessagebox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_message_box</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redefine the method calls for QMessageBox static methods.</span>

<span class="sd">        These are often called from within apps and because QT is running in a</span>
<span class="sd">        separate process, they will pop up behind the After Effects window. Wrap</span>
<span class="sd">        each of these calls in a raise method to activate the QT process.</span>

<span class="sd">        :param q_message_box: The QMessageBox class to patch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">info_fn</span> <span class="o">=</span> <span class="n">q_message_box</span><span class="o">.</span><span class="n">information</span>
        <span class="n">critical_fn</span> <span class="o">=</span> <span class="n">q_message_box</span><span class="o">.</span><span class="n">critical</span>
        <span class="n">question_fn</span> <span class="o">=</span> <span class="n">q_message_box</span><span class="o">.</span><span class="n">question</span>
        <span class="n">warning_fn</span> <span class="o">=</span> <span class="n">q_message_box</span><span class="o">.</span><span class="n">warning</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_info_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__activate_python</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">info_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_critical_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__activate_python</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">critical_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_question_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__activate_python</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">question_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_warning_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__activate_python</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">warning_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">q_message_box</span><span class="o">.</span><span class="n">information</span> <span class="o">=</span> <span class="n">_info_wrapper</span>
        <span class="n">q_message_box</span><span class="o">.</span><span class="n">critical</span> <span class="o">=</span> <span class="n">_critical_wrapper</span>
        <span class="n">q_message_box</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">_question_wrapper</span>
        <span class="n">q_message_box</span><span class="o">.</span><span class="n">warning</span> <span class="o">=</span> <span class="n">_warning_wrapper</span>

    <span class="k">def</span> <span class="nf">__check_for_popups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method will check if a popup dialog from aftereffects was openend</span>
<span class="sd">        and if so, it will raise the window to the front.</span>

<span class="sd">        NOTE:</span>
<span class="sd">            This is only done in windows.</span>
<span class="sd">            TODO: Implement an equivalent method on mac</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_windows</span><span class="p">():</span>
            <span class="c1"># to get all dialogs from After Effects, we have to query the</span>
            <span class="c1"># After Effects process id first. As this code runs inside a</span>
            <span class="c1"># separate python process, we use a subprocess for this.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AFX_PID</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AFX_PID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># the windows tasklist command will provide the process id</span>
                <span class="c1"># of the After Effects executable. As there is always only one</span>
                <span class="c1"># instance of After Effects, this should be safe to determine the</span>
                <span class="c1"># process id.</span>
                <span class="n">pid_query_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;tasklist&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/FI&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ImageName eq AfterFX.exe&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/FO&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;CSV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/NH&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">out_string</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pid_query_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

                <span class="c1"># The out_string will look like:</span>
                <span class="c1"># &quot;AfterFX.ext&quot;,&quot;1234&quot;,&quot;SessionName&quot;,&quot;SessionNum&quot;,&quot;MemoryUsage&quot;</span>
                <span class="c1"># where 1234 describes the pid of After Effects</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;[^0-9]+([0-9]+).*&quot;</span><span class="p">,</span> <span class="n">out_string</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_AFX_PID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_AFX_PID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># with the process id of After Effects, we can get all HWNDS that point to</span>
            <span class="c1"># dialog classes.</span>
            <span class="n">hwnds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">find_windows</span><span class="p">(</span>
                <span class="n">process_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AFX_PID</span><span class="p">,</span>
                <span class="n">class_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_AFX_WIN32_DIALOG_WINDOW_CLASS</span><span class="p">,</span>
                <span class="n">stop_if_found</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># To avoid raising a dialog, that we raised before,</span>
            <span class="c1"># we will compare the list of visible dialog-hwnds with the list</span>
            <span class="c1"># that we already raised.</span>
            <span class="c1"># As we cannot compare the hwnd-pointers directly, we need to compare</span>
            <span class="c1"># the integer value (hwnd long) of the hwnd pointers.</span>

            <span class="c1"># we build a dict that maps the hwnd longs to the current hwnd pointer</span>
            <span class="n">all_hwnds</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">GetWindow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">user32</span><span class="o">.</span><span class="n">GetWindow</span>
            <span class="k">for</span> <span class="n">hwnd</span> <span class="ow">in</span> <span class="n">hwnds</span><span class="p">:</span>
                <span class="c1"># GetWindow with GW_CHILD is used to get the hwnd long that identifies the child window</span>
                <span class="c1"># at the top of the Z order, of the specified parent window pointer.</span>
                <span class="n">all_hwnds</span><span class="p">[</span><span class="n">GetWindow</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__WIN32_GW_CHILD</span><span class="p">)]</span> <span class="o">=</span> <span class="n">hwnd</span>

            <span class="c1"># by comparing the cached hwnd longs with the current list of hwnd longs,</span>
            <span class="c1"># we find out which hwnds are actually pointing to new (unraised) dialogs.</span>
            <span class="n">new_hwnds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_hwnds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_POPUP_CACHE</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">([]))</span>

            <span class="c1"># in case there is a new dialog, we bring it to front and update the cache</span>
            <span class="k">for</span> <span class="n">hwnd_long</span> <span class="ow">in</span> <span class="n">new_hwnds</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">bring_to_front</span><span class="p">(</span><span class="n">all_hwnds</span><span class="p">[</span><span class="n">hwnd_long</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_POPUP_CACHE</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_hwnds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">return</span>

            <span class="c1"># in case there are open dialogs, but we already raised them,</span>
            <span class="c1"># we do nothing.</span>
            <span class="k">if</span> <span class="n">all_hwnds</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># In case there is no open dialog, we will reset the cache to None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_POPUP_CACHE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_win32_get_aftereffects_main_hwnd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Windows specific method to find the main After Effects window</span>
<span class="sd">        handle (HWND)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WIN32_AFTEREFFECTS_MAIN_HWND</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">major</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CC_VERSION_MAPPING</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">minor</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                    <span class="n">found_hwnds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">find_windows</span><span class="p">(</span>
                        <span class="n">class_name</span><span class="o">=</span><span class="s2">&quot;AE_CApplication_</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">),</span>
                        <span class="n">stop_if_found</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">found_hwnds</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_WIN32_AFTEREFFECTS_MAIN_HWND</span> <span class="o">=</span> <span class="n">found_hwnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WIN32_AFTEREFFECTS_MAIN_HWND</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WIN32_AFTEREFFECTS_MAIN_HWND</span>

    <span class="k">def</span> <span class="nf">_win32_get_proxy_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Windows-specific method to get the proxy window that will &#39;own&#39; all</span>
<span class="sd">        Toolkit dialogs.  This will be parented to the main After Effects</span>
<span class="sd">        application.</span>

<span class="sd">        :returns: A QWidget that has been parented to After Effects&#39;s window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the main After Effects window:</span>
        <span class="n">ps_hwnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_win32_get_aftereffects_main_hwnd</span><span class="p">()</span>
        <span class="n">win32_proxy_win</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">proxy_win_hwnd</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ps_hwnd</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtCore</span>

            <span class="c1"># Create the proxy QWidget.</span>
            <span class="n">win32_proxy_win</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
            <span class="n">window_title</span> <span class="o">=</span> <span class="s2">&quot;Flow Production Tracking Parent Widget </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
            <span class="p">)</span>
            <span class="n">win32_proxy_win</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">window_title</span><span class="p">)</span>

            <span class="c1"># With PySide2, we&#39;re required to look up our proxy parent</span>
            <span class="c1"># widget&#39;s HWND the hard way, following the same logic used</span>
            <span class="c1"># to find After Effects&#39;s main window. To do that, we actually have</span>
            <span class="c1"># to show our widget so that Windows knows about it. We can make</span>
            <span class="c1"># it effectively invisible if we zero out its size, so we do that,</span>
            <span class="c1"># show the widget, and then look up its HWND by window title before</span>
            <span class="c1"># hiding it.</span>
            <span class="n">win32_proxy_win</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">win32_proxy_win</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">proxy_win_hwnd_found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">find_windows</span><span class="p">(</span>
                    <span class="n">stop_if_found</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">window_text</span><span class="o">=</span><span class="n">window_title</span>
                <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">win32_proxy_win</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">proxy_win_hwnd_found</span><span class="p">:</span>
                <span class="n">proxy_win_hwnd</span> <span class="o">=</span> <span class="n">proxy_win_hwnd_found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Unable to determine the HWND of After Effects itself. This means &quot;</span>
                <span class="s2">&quot;that we can&#39;t properly setup window parenting for Toolkit apps.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Parent to the After Effects application window if we found everything</span>
        <span class="c1"># we needed. If we didn&#39;t find our proxy window for some reason, we</span>
        <span class="c1"># will return None below. In that case, we&#39;ll just end up with no</span>
        <span class="c1"># window parenting, but apps will still launch.</span>
        <span class="k">if</span> <span class="n">proxy_win_hwnd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Unable setup window parenting properly. Dialogs shown will &quot;</span>
                <span class="s2">&quot;not be parented to After Effects, but they will still function &quot;</span>
                <span class="s2">&quot;properly otherwise.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set the window style/flags. We don&#39;t need or want our Python</span>
            <span class="c1"># dialogs to notify the After Effects application window when they&#39;re</span>
            <span class="c1"># opened or closed, so we&#39;ll disable that behavior.</span>
            <span class="n">win_ex_style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">GetWindowLong</span><span class="p">(</span>
                <span class="n">proxy_win_hwnd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">GWL_EXSTYLE</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">SetWindowLong</span><span class="p">(</span>
                <span class="n">proxy_win_hwnd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">GWL_EXSTYLE</span><span class="p">,</span>
                <span class="n">win_ex_style</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">WS_EX_NOPARENTNOTIFY</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__tk_aftereffects</span><span class="o">.</span><span class="n">win_32_api</span><span class="o">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">proxy_win_hwnd</span><span class="p">,</span> <span class="n">ps_hwnd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_PROXY_WIN_HWND</span> <span class="o">=</span> <span class="n">proxy_win_hwnd</span>

        <span class="k">return</span> <span class="n">win32_proxy_win</span>

    <span class="k">def</span> <span class="nf">_get_dialog_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the QWidget parent for all dialogs created through</span>
<span class="sd">        show_dialog &amp; show_modal.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the QWidget parent for all dialogs created through</span>
<span class="sd">        show_dialog &amp; show_modal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine the parent widget to use:</span>
        <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtGui</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DIALOG_PARENT</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_windows</span><span class="p">():</span>
                <span class="c1"># for windows, we create a proxy window parented to the</span>
                <span class="c1"># main application window that we can then set as the owner</span>
                <span class="c1"># for all Toolkit dialogs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DIALOG_PARENT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_win32_get_proxy_window</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DIALOG_PARENT</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">activeWindow</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DIALOG_PARENT</span>

    <span class="k">def</span> <span class="nf">show_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">widget_class</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows a non-modal dialog window in a way suitable for this engine.</span>
<span class="sd">        The engine will attempt to parent the dialog nicely to the host</span>
<span class="sd">        application.</span>

<span class="sd">        :param title: The title of the window</span>
<span class="sd">        :param bundle: The app, engine or framework object that is associated</span>
<span class="sd">            with this window</span>
<span class="sd">        :param widget_class: The class of the UI to be constructed. This must</span>
<span class="sd">            derive from QWidget.</span>

<span class="sd">        Additional parameters specified will be passed through to the</span>
<span class="sd">        widget_class constructor.</span>

<span class="sd">        :returns: the created widget_class instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Sorry, this environment does not support UI display! Cannot &quot;</span>
                <span class="s2">&quot;show the requested window &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="n">title</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># create the dialog:</span>
        <span class="n">dialog</span><span class="p">,</span> <span class="n">widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dialog_with_widget</span><span class="p">(</span>
            <span class="n">title</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">widget_class</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Note - the base engine implementation will try to clean up</span>
        <span class="c1"># dialogs and widgets after they&#39;ve been closed.  However this</span>
        <span class="c1"># can cause a crash in After Effects as the system may try to send</span>
        <span class="c1"># an event after the dialog has been deleted.</span>
        <span class="c1"># Keeping track of all dialogs will ensure this doesn&#39;t happen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__qt_dialogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dialog</span><span class="p">)</span>

        <span class="c1"># make python active if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__activate_python</span><span class="p">()</span>

        <span class="c1"># make sure the window raised so it doesn&#39;t</span>
        <span class="c1"># appear behind the main After Effects window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Showing dialog: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,))</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">widget</span>

    <span class="k">def</span> <span class="nf">show_modal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">widget_class</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows a modal dialog window in a way suitable for this engine. The</span>
<span class="sd">        engine will attempt to integrate it as seamlessly as possible into the</span>
<span class="sd">        host application. This call is blocking</span>
<span class="sd">        until the user closes the dialog.</span>

<span class="sd">        :param title: The title of the window</span>
<span class="sd">        :param bundle: The app, engine or framework object that is associated</span>
<span class="sd">            with this window</span>
<span class="sd">        :param widget_class: The class of the UI to be constructed. This must</span>
<span class="sd">            derive from QWidget. Additional parameters specified will be passed</span>
<span class="sd">            through to the widget_class constructor.</span>
<span class="sd">        :returns: (a standard QT dialog status return code, the created</span>
<span class="sd">            widget_class instance)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Sorry, this environment does not support UI display! Cannot &quot;</span>
                <span class="s2">&quot;show the requested window &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="n">title</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># create the dialog:</span>
        <span class="n">dialog</span><span class="p">,</span> <span class="n">widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dialog_with_widget</span><span class="p">(</span>
            <span class="n">title</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">widget_class</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Note - the base engine implementation will try to clean up</span>
        <span class="c1"># dialogs and widgets after they&#39;ve been closed.  However this</span>
        <span class="c1"># can cause a crash in After Effects as the system may try to send</span>
        <span class="c1"># an event after the dialog has been deleted.</span>
        <span class="c1"># Keeping track of all dialogs will ensure this doesn&#39;t happen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__qt_dialogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dialog</span><span class="p">)</span>

        <span class="c1"># make python active if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__activate_python</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Showing modal: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,))</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">widget</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># internal methods</span>

    <span class="k">def</span> <span class="nf">__get_command_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a guaranteed unique command id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOCK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_COMMAND_UID_COUNTER</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COMMAND_UID_COUNTER</span>

    <span class="k">def</span> <span class="nf">__get_icon_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes the command properties dictionary to find the most appropriate</span>
<span class="sd">        icon path.</span>

<span class="sd">        This code looks for an `icons` dictionary of the following form::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;dark&quot;: {</span>
<span class="sd">                    &quot;png&quot;: &quot;/path/to/dark_icon.png&quot;,</span>
<span class="sd">                    &quot;svg&quot;: &quot;/path/to/dark_icon.svg&quot;</span>
<span class="sd">                },</span>
<span class="sd">                &quot;light&quot;: {</span>
<span class="sd">                    &quot;png&quot;: &quot;/path/to/light_icon.png&quot;,</span>
<span class="sd">                    &quot;svg&quot;: &quot;/path/to/light_icon.svg&quot;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        For Adobe, the preference is dark png then light png</span>

<span class="sd">        If neither of these is found, fall back to the standard</span>
<span class="sd">        `properties[&quot;icon&quot;]`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">icon_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">icons</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;icons&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">icons</span><span class="p">:</span>
            <span class="n">dark</span> <span class="o">=</span> <span class="n">icons</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dark&quot;</span><span class="p">)</span>
            <span class="n">light</span> <span class="o">=</span> <span class="n">icons</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;light&quot;</span><span class="p">)</span>

            <span class="c1"># check for dark icon</span>
            <span class="k">if</span> <span class="n">dark</span><span class="p">:</span>
                <span class="n">icon_path</span> <span class="o">=</span> <span class="n">dark</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">icon_path</span><span class="p">)</span>

            <span class="c1"># if no dark icon, check the light:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">icon_path</span> <span class="ow">and</span> <span class="n">light</span><span class="p">:</span>
                <span class="n">icon_path</span> <span class="o">=</span> <span class="n">dark</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">icon_path</span><span class="p">)</span>

        <span class="c1"># still no icon path, fall back to regular icon</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">icon_path</span><span class="p">:</span>
            <span class="n">icon_path</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;icon&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">icon_path</span>

    <span class="k">def</span> <span class="nf">__send_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends information back to javascript representing the current context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># alert js that the state is about to change. this allows the panel to</span>
        <span class="c1"># clear its current state and display a loading message.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">context_about_to_change</span><span class="p">()</span>

        <span class="c1"># ---- process the context for display</span>

        <span class="c1"># clear existing context requests to prevent unnecessary processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__context_find_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__context_thumb_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># determine the best entity to show for the current context</span>
        <span class="n">context_entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_context_entity</span><span class="p">()</span>

        <span class="c1"># this will inspect the context and do any additional queries for fields</span>
        <span class="c1"># that are required to show it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__request_context_display</span><span class="p">(</span><span class="n">context_entity</span><span class="p">)</span>

        <span class="c1"># ---- the engine already has access to all the commands that need to</span>
        <span class="c1">#      be display for the current context. so go ahead and process those</span>
        <span class="c1">#      and send them back separately</span>

        <span class="c1"># first, we&#39;ll process the menu favorites</span>
        <span class="n">fav_lookup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fav_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># create a lookup of the combined app instance name with the display</span>
        <span class="c1"># name. that should be unique and provide an easy lookup to match</span>
        <span class="c1"># against. we&#39;ll remember the order processed in order to sort our</span>
        <span class="c1"># favorites list once all the registered commands are processed</span>
        <span class="k">for</span> <span class="n">fav_command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;shelf_favorites&quot;</span><span class="p">):</span>
            <span class="n">app_instance_name</span> <span class="o">=</span> <span class="n">fav_command</span><span class="p">[</span><span class="s2">&quot;app_instance&quot;</span><span class="p">]</span>
            <span class="n">display_name</span> <span class="o">=</span> <span class="n">fav_command</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="c1"># build unique lookup for this combo of app instance and command</span>
            <span class="n">fav_id</span> <span class="o">=</span> <span class="n">app_instance_name</span> <span class="o">+</span> <span class="n">display_name</span>
            <span class="n">fav_lookup</span><span class="p">[</span><span class="n">fav_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">fav_index</span>

            <span class="c1"># give it an index so that we can sort and maintain order later</span>
            <span class="n">fav_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># keep a list of each type of command since they&#39;ll be displayed</span>
        <span class="c1"># differently on the adobe side.</span>
        <span class="n">favorites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">context_menu_cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># iterate over all the registered commands and gather the necessary info</span>
        <span class="c1"># to display them in adobe</span>
        <span class="k">for</span> <span class="n">command_name</span><span class="p">,</span> <span class="n">command_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># commands come with a dict of properties that may or may not</span>
            <span class="c1"># contain certain data.</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">command_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="c1"># ---- determine the app&#39;s instance name</span>

            <span class="n">app_instance</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">app_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># check this command&#39;s app against the engine&#39;s apps.</span>
            <span class="k">if</span> <span class="n">app_instance</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">app_instance_name</span><span class="p">,</span> <span class="n">app_instance_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">app_instance_obj</span> <span class="o">==</span> <span class="n">app_instance</span><span class="p">:</span>
                        <span class="n">app_name</span> <span class="o">=</span> <span class="n">app_instance_name</span>

            <span class="n">cmd_type</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>

            <span class="c1"># create the command dict to hand over to adobe</span>
            <span class="n">command</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">uid</span><span class="o">=</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                <span class="n">display_name</span><span class="o">=</span><span class="n">command_name</span><span class="p">,</span>
                <span class="n">icon_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_icon_path</span><span class="p">(</span><span class="n">properties</span><span class="p">),</span>
                <span class="n">description</span><span class="o">=</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># build the lookup string to see if this app is a favorite</span>
            <span class="n">fav_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span> <span class="o">+</span> <span class="n">command_name</span>

            <span class="k">if</span> <span class="n">cmd_type</span> <span class="o">==</span> <span class="s2">&quot;context_menu&quot;</span><span class="p">:</span>
                <span class="c1"># these commands will show up in the panel flyout menu</span>
                <span class="n">context_menu_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fav_name</span> <span class="ow">in</span> <span class="n">fav_lookup</span><span class="p">:</span>
                <span class="c1"># add the fav index to the command so that we can sort after</span>
                <span class="c1"># all favorites are identified.</span>
                <span class="n">command</span><span class="p">[</span><span class="s2">&quot;fav_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fav_lookup</span><span class="p">[</span><span class="n">fav_name</span><span class="p">]</span>
                <span class="n">favorites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="c1"># ---- include the &quot;jump to&quot; commands that are common to all engines</span>

        <span class="n">jump_commands</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># the icon to use for the command. bundled with the engine</span>
        <span class="n">sg_icon</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_location</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;shotgun_logo.png&quot;</span><span class="p">)</span>

        <span class="n">jump_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">uid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__jump_to_sg_command_id</span><span class="p">,</span>
                <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Jump to Flow Production Tracking&quot;</span><span class="p">,</span>
                <span class="n">icon_path</span><span class="o">=</span><span class="n">sg_icon</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Open the current context in a web browser.&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;context_menu&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">filesystem_locations</span><span class="p">:</span>
            <span class="c1"># the icon to use for the command. bundled with the engine</span>
            <span class="n">fs_icon</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disk_location</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;shotgun_folder.png&quot;</span>
            <span class="p">)</span>

            <span class="n">jump_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">uid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__jump_to_fs_command_id</span><span class="p">,</span>
                    <span class="n">display_name</span><span class="o">=</span><span class="s2">&quot;Jump to File System&quot;</span><span class="p">,</span>
                    <span class="n">icon_path</span><span class="o">=</span><span class="n">fs_icon</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Open the current context in a file browser.&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;context_menu&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># sort the favorites based on their index</span>
        <span class="n">favorites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">favorites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;fav_index&quot;</span><span class="p">])</span>

        <span class="c1"># sort the other commands alphabetically by display name</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;display_name&quot;</span><span class="p">])</span>

        <span class="c1"># sort the context menu commands alphabetically by display name. We</span>
        <span class="c1"># force the Jump to Shotgun and Jump to Filesystem commands onto the</span>
        <span class="c1"># front of the list to match other integrations.</span>
        <span class="n">context_menu_cmds</span> <span class="o">=</span> <span class="n">jump_commands</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">context_menu_cmds</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;display_name&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># ---- populate the state structure to hand over to adobe</span>

        <span class="n">all_commands</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;favorites&quot;</span><span class="p">:</span> <span class="n">favorites</span><span class="p">,</span>
            <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="n">commands</span><span class="p">,</span>
            <span class="s2">&quot;context_menu_cmds&quot;</span><span class="p">:</span> <span class="n">context_menu_cmds</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># send the commands back to adobe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">send_commands</span><span class="p">(</span><span class="n">all_commands</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setup_connection_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the connection timer that handles monitoring of the live</span>
<span class="sd">        connection, as well as the triggering of message processing.</span>

<span class="sd">        :param bool force: Forces the creation of a new connection timer,</span>
<span class="sd">                           even if one already exists. When this occurs,</span>
<span class="sd">                           if a timer already exists, it will be stopped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CHECK_CONNECTION_TIMER</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating connection timer...&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CHECK_CONNECTION_TIMER</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Connection timer already exists, so it will be stopped.&quot;</span>
                <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_CHECK_CONNECTION_TIMER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># No reason to be alarmed here. Just let it go and it&#39;ll</span>
                    <span class="c1"># garbage collected when appropriate.</span>
                    <span class="k">pass</span>

            <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtCore</span>

            <span class="n">timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_connection</span><span class="p">)</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__check_for_popups</span><span class="p">)</span>

            <span class="c1"># The class variable is in seconds, so multiply to get milliseconds.</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SHOTGUN_ADOBE_HEARTBEAT_INTERVAL</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_CHECK_CONNECTION_TIMER</span> <span class="o">=</span> <span class="n">timer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Connection timer created and started.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_jump_to_sg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Jump to shotgun, launch web browser</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sgtk.platform.qt</span> <span class="kn">import</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtCore</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">shotgun_url</span>
        <span class="n">QtGui</span><span class="o">.</span><span class="n">QDesktopServices</span><span class="o">.</span><span class="n">openUrl</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QUrl</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_jump_to_fs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Jump from context to FS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># launch one window for each location on disk</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">filesystem_locations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FS paths: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">paths</span><span class="p">),))</span>
        <span class="k">for</span> <span class="n">disk_location</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="c1"># run the app</span>
            <span class="k">if</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_macos</span><span class="p">():</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;open &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">disk_location</span>
            <span class="k">elif</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_windows</span><span class="p">():</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;cmd.exe /C start &quot;Folder&quot; &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">disk_location</span>
            <span class="k">elif</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_linux</span><span class="p">():</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;xdg-open &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">disk_location</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Platform &#39;</span><span class="si">%s</span><span class="s2">&#39; is not supported.&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>

            <span class="n">exit_code</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to launch &#39;</span><span class="si">%s</span><span class="s2">&#39;!&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># context data methods</span>

    <span class="k">def</span> <span class="nf">__add_to_context_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the given active document path to the context cache, associating</span>
<span class="sd">        it with the given context object. This will trigger the storing of a</span>
<span class="sd">        serialized cache as a user setting for use during panel extension</span>
<span class="sd">        restarts.</span>

<span class="sd">        :param str path: The document path to add to the cache.</span>
<span class="sd">        :param context: The context object to associate with the document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CACHE</span><span class="p">:</span>
            <span class="c1"># We&#39;re storing the context cache in a sgtk user setting at the project</span>
            <span class="c1"># level. This will ensure that when we read the cache back, we&#39;ll only</span>
            <span class="c1"># be getting contexts in our current project. Anything outside of that</span>
            <span class="c1"># scope would be unusable, as we don&#39;t allow context changing across</span>
            <span class="c1"># project boundaries.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CACHE</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>

            <span class="n">serial_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CACHE</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">serial_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Storing context cache: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">serial_cache</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__settings_manager</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CACHE_KEY</span><span class="p">,</span>
                <span class="n">serial_cache</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__settings_manager</span><span class="o">.</span><span class="n">SCOPE_PROJECT</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_from_context_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the document path&#39;s associated context object, if one has been cached.</span>

<span class="sd">        :returns: Context object, or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONTEXT_CACHE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__request_context_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request fields to show in the context header for the given entity.</span>

<span class="sd">        Always includes the image url to display a thumbnail.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span><span class="p">:</span>
            <span class="c1"># no entity. this will retrieve the html to display for the site.</span>
            <span class="n">fields_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_hook_method</span><span class="p">(</span>
                <span class="s2">&quot;context_fields_display_hook&quot;</span><span class="p">,</span>
                <span class="s2">&quot;get_context_html&quot;</span><span class="p">,</span>
                <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sg_globals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__shotgun_globals</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">send_context_display</span><span class="p">(</span><span class="n">fields_html</span><span class="p">)</span>

            <span class="c1"># go ahead and forward the site thumbnail back to js</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">thumb_path</span><span class="o">=</span><span class="s2">&quot;../images/default_Site_thumb_dark.png&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sgtk</span><span class="o">.</span><span class="n">shotgun_url</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">send_context_thumbnail</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># get the fields to query from the hook</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_hook_method</span><span class="p">(</span>
            <span class="s2">&quot;context_fields_display_hook&quot;</span><span class="p">,</span>
            <span class="s2">&quot;get_entity_fields&quot;</span><span class="p">,</span>
            <span class="n">entity_type</span><span class="o">=</span><span class="n">entity</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># always try to query the image for the entity</span>
        <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>

        <span class="n">entity_type</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">entity_id</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

        <span class="c1"># kick off an async request to query the necessary fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__context_find_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data</span><span class="o">.</span><span class="n">execute_find_one</span><span class="p">(</span>
            <span class="n">entity_type</span><span class="p">,</span> <span class="p">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">]],</span> <span class="n">fields</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__on_worker_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronous callback - the worker thread errored.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># log a message if the worker failed to retrieve the necessary info.</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__context_find_uid</span><span class="p">:</span>
            <span class="c1"># clear the find id since we are now processing it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__context_find_uid</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># send an error message back to the context header.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">send_context_display</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                There was an error retrieving fields for this context. Please</span>
<span class="sd">                see the logs for the specific error message. If this is a</span>
<span class="sd">                recurring error and you need further assistance, please</span>
<span class="sd">                contact our support team via &lt;a href=&#39;{url}&#39;&gt;</span>
<span class="sd">                {url}&lt;/a&gt;.</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sgtk</span><span class="o">.</span><span class="n">support_url</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to query context fields: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,))</span>

        <span class="k">elif</span> <span class="n">uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__context_thumb_uid</span><span class="p">:</span>
            <span class="c1"># clear the thumb id since we are now processing it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__context_thumb_uid</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># log this. the panel will display a default thumbnail, so this</span>
            <span class="c1"># should be sufficient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to query context thumbnail: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">__on_worker_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">request_type</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signaled whenever the worker completes something.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Worker signal: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">,))</span>

        <span class="c1"># the find query for the context entity with the specified fields</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__context_find_uid</span><span class="p">:</span>
            <span class="c1"># clear the find id since we are now processing it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__context_find_uid</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">context_entity</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sg&quot;</span><span class="p">]</span>

            <span class="c1"># should have an image url now. submit a request to download the</span>
            <span class="c1"># entity&#39;s thumbnail.</span>
            <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">context_entity</span> <span class="ow">and</span> <span class="n">context_entity</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__context_thumb_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data</span><span class="o">.</span><span class="n">request_thumbnail</span><span class="p">(</span>
                    <span class="n">context_entity</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span>
                    <span class="n">context_entity</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
                    <span class="n">context_entity</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;image&quot;</span><span class="p">,</span>
                    <span class="n">load_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># no image, use a default image based on the entity type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">context_entity</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Project&quot;</span><span class="p">,</span> <span class="s2">&quot;Shot&quot;</span><span class="p">,</span> <span class="s2">&quot;Task&quot;</span><span class="p">]:</span>
                    <span class="n">thumb_path</span> <span class="o">=</span> <span class="s2">&quot;../images/default_</span><span class="si">%s</span><span class="s2">_thumb_dark.png&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">context_entity</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;thumb_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thumb_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">thumb_path</span> <span class="o">=</span> <span class="s2">&quot;../images/default_Entity_thumb_dark.png&quot;</span>

                <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">thumb_path</span><span class="o">=</span><span class="n">thumb_path</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_entity_url</span><span class="p">(</span><span class="n">context_entity</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">send_context_thumbnail</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># now that we have all the field values, go back to the hook and</span>
            <span class="c1"># build the html to display them.</span>
            <span class="n">fields_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_hook_method</span><span class="p">(</span>
                <span class="s2">&quot;context_fields_display_hook&quot;</span><span class="p">,</span>
                <span class="s2">&quot;get_context_html&quot;</span><span class="p">,</span>
                <span class="n">entity</span><span class="o">=</span><span class="n">context_entity</span><span class="p">,</span>
                <span class="n">sg_globals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__shotgun_globals</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># forward the display html back to the js panel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">send_context_display</span><span class="p">(</span><span class="n">fields_html</span><span class="p">)</span>

        <span class="c1"># thumbnail download. forward the path and a url back to js</span>
        <span class="k">elif</span> <span class="n">uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__context_thumb_uid</span><span class="p">:</span>
            <span class="c1"># clear the thumb id since we already processed it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__context_thumb_uid</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">context_entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_context_entity</span><span class="p">()</span>

            <span class="c1"># add a url to allow the panel to make the thumbnail clickable</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entity_url</span><span class="p">(</span><span class="n">context_entity</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">send_context_thumbnail</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_project_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to return the project id for the current context.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__get_context_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to return an entity to display for current context.&quot;&quot;&quot;</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>

        <span class="c1"># determine the best entity for displaying the thumbnail. just return</span>
        <span class="c1"># the first of task, entity, project that is defined</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">return</span> <span class="n">entity</span>

    <span class="k">def</span> <span class="nf">get_entity_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to return a PTR url for the supplied entity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/detail/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sgtk</span><span class="o">.</span><span class="n">shotgun_url</span><span class="p">,</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_panel_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to return an html link to display in the panel and</span>
<span class="sd">        will launch the supplied url in the default browser.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;a</span>
<span class="s2">              href=&#39;#&#39;</span>
<span class="s2">              class=&#39;sg_value_link&#39;</span>
<span class="s2">              onclick=&#39;sg_panel.Panel.open_external_url(&quot;</span><span class="si">{url}</span><span class="s2">&quot;)&#39;</span>
<span class="s2">            &gt;</span><span class="si">{text}</span><span class="s2">&lt;/a&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__activate_python</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do the Os-specific thing to show this process above all others.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_macos</span><span class="p">():</span>
            <span class="c1"># a little action script to activate the given python process.</span>
            <span class="n">osx_activate_script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                tell application &quot;System Events&quot;</span>
<span class="s2">                  set frontmost of the first process whose unix id is </span><span class="si">{pid}</span><span class="s2"> to true</span>
<span class="s2">                end tell</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pid</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c1"># force this python process to the front</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;osascript&quot;</span><span class="p">,</span> <span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="n">osx_activate_script</span><span class="p">]</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not activate python.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">is_windows</span><span class="p">():</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__import_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does the import and gets all new items, by caching the list of existing</span>
<span class="sd">        items before importing and comparing them to the list of existing items</span>
<span class="sd">        after importing.</span>

<span class="sd">        :param import_options: Import options object that should be imported</span>
<span class="sd">        :type import_options: `adobe.ImportOptionsObject`_</span>
<span class="sd">        :returns: All new items that were imported</span>
<span class="sd">        :rtype: list-of-`adobe.CompItemObject`_</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># as the return value of importFile will not</span>
        <span class="c1"># reliably return the new items, one</span>
        <span class="c1"># has to track the changes</span>
        <span class="n">item_cache</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">rootFolder</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="n">item_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># do the import</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">importFile</span><span class="p">(</span><span class="n">import_options</span><span class="p">)</span>

        <span class="n">new_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adobe</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">rootFolder</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item_cache</span><span class="p">:</span>
                <span class="n">new_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_items</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Autodesk.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 

  <script type="text/javascript">
    window.wafCCPAForceShow = true;
    (function(a,b,c,d){
      a='https://tags.tiqcdn.com/utag/autodesk/micro-basic/prod/utag.js';
      b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
      a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
    })();
  </script>


</body>
</html>